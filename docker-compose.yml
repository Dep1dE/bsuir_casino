version: '3.8'

services:
  casino.api:
    image: ${DOCKER_REGISTRY-}casinoapi
    build:
      context: ./src
      dockerfile: Casino.Api/Dockerfile
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
    ports:
      - "5000:8080"
    depends_on:
      db:
        condition: service_healthy
      solana:
        condition: service_healthy

  db:
    image: postgres:16
    restart: always
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: admin
    volumes:
      - database_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin"]
      interval: 5s
      timeout: 5s
      retries: 5

  adminer:
    image: adminer
    restart: always
    ports:
      - "8080:8080"

  solana:
    image: ${SOLANA_IMAGE:-}
    build:
      context: ./solana-validator
      dockerfile: Dockerfile
    container_name: solana-test-validator
    ports:
      - "8899:8899"
      - "8900:8900"
      - "8001:8001"
      - "8002:8002"
      - "8003:8003"
    volumes:
      - solana_data:/root/.local/share/solana
    command: ["solana-test-validator", "--bind-address", "0.0.0.0", "--rpc-port", "8899", "--ledger", "/root/.local/share/solana", "--faucet-sol", "1000000", "--limit-ledger-size"]
    healthcheck:
      test: ["CMD-SHELL", "timeout 1 bash -c '</dev/tcp/localhost/8899' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    restart: unless-stopped
    shm_size: 11gb
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
      stack:
        soft: -1
        hard: -1

  ngrok:
    image: ngrok/ngrok:latest
    restart: unless-stopped
    command: http casino.api:8080
    environment:
      NGROK_AUTHTOKEN: "36ZNI6yMmFgs8y60bWmnBOuRIkC_qQtN5kTErsBZuLBXnMt3"
    ports:
      - "4040:4040" 
    depends_on:
      - casino.api
    networks:
      - default

volumes:
  database_data:
    driver: local
  solana_data:
    driver: local